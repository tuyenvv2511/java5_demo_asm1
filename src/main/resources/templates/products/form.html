<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
<body th:replace="~{layout :: layout(content=~{::section})}">
<section class="bg-white p-4 rounded-3 shadow-sm">
    <form th:action="@{/products}" method="post" th:object="${product}" enctype="multipart/form-data">
        <input type="hidden" th:field="*{id}">
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label" th:text="#{product.title}">Title</label>
                <input class="form-control" th:field="*{title}" required>
            </div>
            <div class="col-md-6">
                <label class="form-label" th:text="#{product.price}">Price</label>
                <div class="input-group">
                    <input type="number" min="0" step="1000" class="form-control" th:field="*{price}" required id="priceInput">
                    <button type="button" class="btn btn-outline-primary" onclick="getAISuggestion()" id="aiSuggestBtn">
                        <i class="fas fa-brain"></i> AI G·ª£i √Ω
                    </button>
                </div>
                
                <!-- Test button for debugging -->
                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-warning" onclick="testFunction()">
                        <i class="fas fa-bug"></i> Test
                    </button>
                </div>
                
                <!-- AI Pricing Suggestion -->
                <div id="aiSuggestion" class="mt-2" style="display: none;">
                    <div class="alert alert-info">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>ü§ñ G·ª£i √Ω AI:</strong>
                                <span id="suggestedPrice" class="ms-2"></span>
                                <br>
                                <small id="suggestionDetails" class="text-muted"></small>
                            </div>
                            <div>
                                <button type="button" class="btn btn-sm btn-success" onclick="applySuggestion()">
                                    <i class="fas fa-magic"></i> √Åp d·ª•ng
                                </button>
                                <button type="button" class="btn btn-sm btn-secondary" onclick="hideSuggestion()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12">
                <label class="form-label" th:text="#{product.description}">Description</label>
                <textarea class="form-control" th:field="*{description}" rows="3"></textarea>
            </div>
            <div class="col-12">
                <label class="form-label" th:text="#{product.image}">Product Image</label>
                <input type="file" class="form-control" name="imageFile" accept="image/*" id="imageFile">
                <div class="form-text" th:text="#{product.imageHelp}">Choose image from your computer (JPG, PNG, GIF - maximum 10MB)</div>
                
                <!-- Display current image if exists -->
                <div th:if="${product.imageUrl != null and product.imageUrl != ''}" class="mt-3">
                    <label class="form-label" th:text="#{product.currentImage}">Current Image:</label>
                    <div>
                        <img th:src="${product.imageUrl}" alt="Product Image" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                    </div>
                </div>
                
                <!-- Preview new image -->
                <div id="imagePreview" class="mt-3" style="display: none;">
                    <label class="form-label" th:text="#{product.newImage}">New Image:</label>
                    <div>
                        <img id="previewImg" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <label class="form-label" th:text="#{product.condition}">Condition</label>
                <select class="form-select" th:field="*{conditionGrade}">
                    <option th:each="c : ${conditions}" th:value="${c}" th:text="${c}"></option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label" th:text="#{product.brand}">Brand</label>
                <select class="form-select" th:field="*{brand}" required>
                    <option th:each="b : ${brands}" th:value="${b.id}" th:text="${b.name}"></option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label" th:text="#{product.category}">Category</label>
                <select class="form-select" th:field="*{category}" required>
                    <option th:each="c : ${categories}" th:value="${c.id}" th:text="${c.name}"></option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label" th:text="#{product.seller}">Seller</label>
                <select class="form-select" th:field="*{seller}" required id="sellerSelect">
                    <option th:each="u : ${users}" th:value="${u.id}" th:text="${u.username}" 
                            th:selected="${currentUser != null and currentUser.id == u.id}"></option>
                </select>
                <!-- Auto-select current user as seller if they have SELLER role -->
                <div th:if="${currentUser != null}" class="form-text">
                    <i class="fas fa-info-circle text-primary"></i>
                    <span th:text="'T·ª± ƒë·ªông ch·ªçn: ' + ${currentUser.username}">T·ª± ƒë·ªông ch·ªçn: seller1</span>
                </div>
            </div>
            <div class="col-12 form-check">
                <input class="form-check-input" type="checkbox" th:field="*{active}">
                <label class="form-check-label" th:text="#{product.active}">Active</label>
            </div>
            <div class="col-12 d-flex gap-2 mt-3">
                <button class="btn btn-primary" name="applySuggest" value="false" th:text="#{btn.save}">Save</button>
                <button class="btn btn-outline-primary" name="applySuggest" value="true" th:text="#{pricing.suggest}">
                    Apply suggest
                </button>
                <a class="btn btn-secondary" th:href="@{/products}" th:text="#{btn.back}">Back</a>
            </div>
        </div>
    </form>
</section>

<script>
    // AI Pricing Suggestion - Real API version
    function getAISuggestion() {
        console.log('AI Suggestion button clicked!');
        
        const btn = document.getElementById('aiSuggestBtn');
        const suggestion = document.getElementById('aiSuggestion');
        
        if (!btn || !suggestion) {
            console.error('Required elements not found!');
            alert('L·ªói: Kh√¥ng t√¨m th·∫•y c√°c ph·∫ßn t·ª≠ c·∫ßn thi·∫øt!');
            return;
        }
        
        // Show loading state
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang ph√¢n t√≠ch...';
        btn.disabled = true;
        
        // Get form data
        const title = document.querySelector('input[name="title"]')?.value || '';
        const brandId = document.querySelector('select[name="brand"]')?.value || '';
        const categoryId = document.querySelector('select[name="category"]')?.value || '';
        const condition = document.querySelector('select[name="conditionGrade"]')?.value || '';
        const currentPrice = document.getElementById('priceInput')?.value || '0';
        
        console.log('Form data:', { title, brandId, categoryId, condition, currentPrice });
        
        // Create form data
        const formData = new FormData();
        formData.append('title', title);
        formData.append('brandId', brandId);
        formData.append('categoryId', categoryId);
        formData.append('condition', condition);
        formData.append('currentPrice', currentPrice);
        
        // Call real API
        console.log('Calling API...');
        fetch('/products/ai-suggestion', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log('API response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('API response data:', data);
            if (data.success) {
                const suggestedPrice = new Intl.NumberFormat('vi-VN').format(data.suggestedPrice) + ' VNƒê';
                document.getElementById('suggestedPrice').textContent = suggestedPrice;
                
                // Show detailed suggestion
                let details = data.reasoning;
                if (data.confidence) {
                    details += ` (ƒê·ªô tin c·∫≠y: ${data.confidence}%)`;
                }
                if (data.trend && data.percentage) {
                    const trendIcon = data.trend === 'increasing' ? 'üìà' : data.trend === 'decreasing' ? 'üìâ' : '‚û°Ô∏è';
                    const percentage = Math.abs(data.percentage);
                    details += ` ${trendIcon} ${percentage.toFixed(1)}%`;
                }
                
                document.getElementById('suggestionDetails').textContent = details;
                suggestion.style.display = 'block';
                suggestion.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
                console.log('Real AI suggestion shown:', data.suggestedPrice);
            } else {
                console.log('API returned success: false, using fallback');
                showFallbackSuggestion();
            }
        })
        .catch(error => {
            console.error('Error getting AI suggestion:', error);
            showFallbackSuggestion();
        })
        .finally(() => {
            btn.innerHTML = '<i class="fas fa-brain"></i> AI G·ª£i √Ω';
            btn.disabled = false;
        });
        
        function showFallbackSuggestion() {
            const currentPrice = document.getElementById('priceInput')?.value || 0;
            const suggestedPrice = Math.round(currentPrice * 0.95);
            
            document.getElementById('suggestedPrice').textContent = 
                new Intl.NumberFormat('vi-VN').format(suggestedPrice) + ' VNƒê';
            document.getElementById('suggestionDetails').textContent = 
                'D·ª±a tr√™n xu h∆∞·ªõng th·ªã tr∆∞·ªùng v√† t√¨nh tr·∫°ng s·∫£n ph·∫©m (ch·∫ø ƒë·ªô demo)';
            suggestion.style.display = 'block';
            suggestion.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }
    
    function applySuggestion() {
        const suggestedPrice = document.getElementById('suggestedPrice').textContent;
        const priceValue = suggestedPrice.replace(/[^\d]/g, ''); // Extract number only
        document.getElementById('priceInput').value = priceValue;
        hideSuggestion();
        
        // Show success message
        const alert = document.createElement('div');
        alert.className = 'alert alert-success alert-dismissible fade show mt-2';
        alert.innerHTML = `
            <i class="fas fa-check-circle"></i> ƒê√£ √°p d·ª•ng gi√° g·ª£i √Ω c·ªßa AI!
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.getElementById('aiSuggestion').parentNode.insertBefore(alert, document.getElementById('aiSuggestion').nextSibling);
        
        setTimeout(() => alert.remove(), 3000);
    }
    
    function hideSuggestion() {
        document.getElementById('aiSuggestion').style.display = 'none';
    }

    // Test function for debugging
    function testFunction() {
        console.log('Test button clicked!');
        alert('JavaScript ƒëang ho·∫°t ƒë·ªông!');
        
        // Test if elements exist
        const btn = document.getElementById('aiSuggestBtn');
        const suggestion = document.getElementById('aiSuggestion');
        const priceInput = document.getElementById('priceInput');
        
        console.log('AI Button:', btn);
        console.log('Suggestion box:', suggestion);
        console.log('Price input:', priceInput);
        
        if (btn && suggestion && priceInput) {
            alert('T·∫•t c·∫£ c√°c ph·∫ßn t·ª≠ ƒë·ªÅu t·ªìn t·∫°i!');
        } else {
            alert('Thi·∫øu m·ªôt s·ªë ph·∫ßn t·ª≠!');
        }
    }

    // Auto-select current user as seller when form loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing...');
        
        const currentUserInfo = document.querySelector('[th\\:if="${currentUser != null}"]');
        if (currentUserInfo) {
            // Extract current user ID from the form data (if available)
            const currentUserId = /*[[${currentUser.id}]]*/ null;
            if (currentUserId) {
                const sellerSelect = document.getElementById('sellerSelect');
                sellerSelect.value = currentUserId;
            }
        }
        
        // Test if AI suggestion elements exist
        const aiBtn = document.getElementById('aiSuggestBtn');
        const aiSuggestion = document.getElementById('aiSuggestion');
        
        if (aiBtn && aiSuggestion) {
            console.log('AI suggestion elements found and ready!');
        } else {
            console.error('AI suggestion elements not found!');
        }
    });

    // Preview h√¨nh ·∫£nh khi ch·ªçn file
    document.getElementById('imageFile').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('previewImg').src = e.target.result;
                document.getElementById('imagePreview').style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            document.getElementById('imagePreview').style.display = 'none';
        }
    });
</script>
</body>
</html>
