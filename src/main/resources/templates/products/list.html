<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" th:replace="~{layout :: layout(content=~{::section})}">
<section th:fragment="content">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1" th:text="#{nav.products}">Products</h2>
            <p class="text-muted mb-0" th:text="#{product.explore}">Khám phá các sản phẩm sưu tầm độc đáo</p>
        </div>
        <!-- Create button only for SELLER -->
        <a class="btn btn-success" th:href="@{/products/create}" sec:authorize="hasRole('SELLER')">
            <i class="fas fa-plus me-2"></i><span th:text="#{btn.create}">Create</span>
        </a>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <form class="row g-3">
                <div class="col-md-3">
                    <label class="form-label"><i class="fas fa-tags me-1"></i>[[#{filter.brand}]]</label>
                    <select name="brand" class="form-select">
                        <option value="" th:text="#{filter.all.brands}">Tất cả thương hiệu</option>
                        <option th:each="b : ${brands}" th:value="${b.slug}" th:text="${b.name}"
                                th:selected="${brand == b.slug}"></option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label"><i class="fas fa-list me-1"></i>[[#{filter.category}]]</label>
                    <select name="category" class="form-select">
                        <option value="" th:text="#{filter.all.categories}">Tất cả danh mục</option>
                        <option th:each="c : ${categories}" th:value="${c.slug}" th:text="${c.name}"
                                th:selected="${category == c.slug}"></option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label"><i class="fas fa-search me-1"></i>[[#{search.placeholder}]]</label>
                    <input class="form-control" name="q" th:value="${q}" th:placeholder="#{search.placeholder}">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-primary w-100" th:text="#{filter.button}">
                        <i class="fas fa-filter me-1"></i>Filter
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover bg-white shadow-sm">
            <thead>
            <tr>
                <th th:text="#{product.id}">ID</th>
                <th th:text="#{product.title}">Title</th>
                <th th:text="#{product.price}">Price</th>
                <th th:text="#{product.condition}">Condition</th>
                <th th:text="#{product.brand}">Brand</th>
                <th th:text="#{product.category}">Category</th>
                <th th:text="#{product.seller}">Seller</th>
                <th th:text="#{verification.status}">Verification</th>
                <th th:text="#{product.actions}">Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="p : ${products}">
                <td th:text="${p.id}">1</td>
                <td>
                    <div class="d-flex align-items-center">
                        <!-- Hiển thị hình ảnh sản phẩm -->
                        <div class="me-3">
                            <img th:if="${p.imageUrl != null and p.imageUrl != ''}" 
                                 th:src="${p.imageUrl}" 
                                 alt="Product Image" 
                                 class="product-image">
                            <div th:unless="${p.imageUrl != null and p.imageUrl != ''}" 
                                 class="product-image bg-light d-flex align-items-center justify-content-center">
                                <i class="fas fa-image text-muted"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1 fw-semibold" th:text="${p.title}">Title</h6>
                            <div class="d-flex gap-2 flex-wrap">
                                <a class="btn btn-sm btn-outline-primary"
                                   th:attr="data-product-id=${p.id}, data-title=${p.title}"
                                   onclick="openChat(this)">
                                    <i class="fas fa-comments me-1"></i>[[#{chat.join}]]
                                </a>
                                <!-- Buy button only for BUYER role -->
                                <a th:if="${p.active}" sec:authorize="hasRole('BUYER')"
                                   th:href="@{/orders/buy/{id}(id=${p.id})}" 
                                   class="btn btn-sm btn-success">
                                    <i class="fas fa-shopping-cart me-1"></i><span th:text="#{product.buyNow}">Buy Now</span>
                                </a>
                                <span th:unless="${p.active}" 
                                      class="badge bg-secondary" th:text="#{product.sold}">Sold</span>
                                <!-- Show login prompt for non-buyers -->
                                <small th:if="${p.active}" sec:authorize="!hasRole('BUYER')"
                                       class="text-muted" th:text="#{product.login.buyer.prompt}">Đăng nhập với tài khoản BUYER để mua</small>
                            </div>
                        </div>
                    </div>
                </td>
                <td>
                    <div th:if="${p.hasActivePromotion()}" class="text-end">
                        <div class="text-decoration-line-through text-muted small mb-1" 
                             th:text="${#numbers.formatInteger(p.price,3,'POINT')} + ' ₫'">4,200,000 ₫</div>
                        <div class="text-danger fw-bold fs-6" 
                             th:text="${#numbers.formatInteger(p.discountedPrice,3,'POINT')} + ' ₫'">3,500,000 ₫</div>
                        <span class="badge bg-danger small">Sale</span>
                    </div>
                    <div th:unless="${p.hasActivePromotion()}" class="text-end">
                        <div class="fw-bold text-dark fs-6" 
                             th:text="${#numbers.formatInteger(p.price,3,'POINT')} + ' ₫'">4,200,000 ₫</div>
                    </div>
                </td>
                <td th:text="#{'condition.' + ${p.conditionGrade}}">LIKE_NEW</td>
                <td th:text="${p.brand != null ? p.brand.name : '-'}">Nike</td>
                <td th:text="${p.category != null ? p.category.name : '-'}">Sneaker</td>
                <td th:text="${p.seller != null ? p.seller.username : '-'}">Seller</td>
                <td>
                    <span class="badge bg-warning" th:text="#{product.pending}">Pending</span>
                </td>
                <td>
                    <div class="d-flex gap-1">
                        <!-- Chỉ hiển thị nút Edit/Delete cho admin hoặc seller sở hữu sản phẩm -->
                        <a th:href="@{|/products/${p.id}/edit|}" class="btn btn-sm btn-primary"
                           th:text="#{btn.edit}"
                           sec:authorize="hasRole('ADMIN') or (hasRole('SELLER') and authentication.name == p.seller.username)">
                            <i class="fas fa-edit"></i>
                        </a>
                        <form th:action="@{|/products/${p.id}/delete|}" method="post" class="d-inline"
                              sec:authorize="hasRole('ADMIN') or (hasRole('SELLER') and authentication.name == p.seller.username)">
                            <button class="btn btn-sm btn-danger" 
                                    th:onclick="'return confirm(\'' + #{product.deleteConfirm} + '\')'">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

<!-- Chat modal -->
<div class="modal fade" id="chatModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="chatTitle" class="modal-title" th:text="#{product.chat}">Chat</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="chatBox" style="min-height:200px"></div>
            <div class="modal-footer">
                <input class="form-control" id="chatSender" th:placeholder="#{product.nickname}">
                <input class="form-control" id="chatInput" th:placeholder="#{product.message}">
                <button class="btn btn-primary" onclick="sendMsg()" th:text="#{product.send}">Send</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    let stompClient = null, currentProductId = null;

    function connectWs(pid) {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, () => {
            stompClient.subscribe('/topic/chat.' + pid, (msg) => {
                const body = JSON.parse(msg.body);
                const box = document.getElementById('chatBox');
                const line = document.createElement('div');
                line.textContent = body.sender + ': ' + body.content;
                box.appendChild(line);
                box.scrollTop = box.scrollHeight;
            });
        });
    }

    function openChat(btn) {
        currentProductId = btn.getAttribute('data-product-id');
        document.getElementById('chatTitle').textContent = 'Chat - ' + btn.getAttribute('data-title');
        document.getElementById('chatBox').innerHTML = '';
        loadHistory(currentProductId);
        const modal = new bootstrap.Modal('#chatModal');
        modal.show();
        connectWs(currentProductId);
    }

    function loadHistory(pid) {
        fetch('/api/messages?productId=' + pid)
            .then(r => r.json())
            .then(msgs => {
                const box = document.getElementById('chatBox');
                msgs.forEach(msg => {
                    const line = document.createElement('div');
                    line.textContent = msg.senderName + ': ' + msg.content;
                    box.appendChild(line);
                });
                box.scrollTop = box.scrollHeight;
            });
    }

    function sendMsg() {
        const sender = document.getElementById('chatSender').value || 'guest';
        const content = document.getElementById('chatInput').value;
        if (!content) return;
        stompClient.send('/app/chat.send', {}, JSON.stringify({
            productId: currentProductId, 
            senderId: null, // Không cần senderId
            sender: sender, 
            content: content
        }));
        document.getElementById('chatInput').value = '';
    }
</script>
</section>
</html>