<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security" th:replace="~{layout :: layout(content=~{::section})}">
<section th:fragment="content">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-1">üõçÔ∏è <span th:text="#{nav.products}">Products</span></h2>
                <p class="text-muted mb-0" th:text="#{product.explore}">Kh√°m ph√° c√°c s·∫£n ph·∫©m s∆∞u t·∫ßm ƒë·ªôc ƒë√°o v·ªõi gi√° t·ªët nh·∫•t</p>
            </div>
            <!-- Create button only for SELLER -->
            <div>
                <a class="btn btn-primary btn-lg" th:href="@{/products/create}" sec:authorize="hasRole('SELLER')">
                    <i class="fas fa-plus me-2"></i><span th:text="#{btn.create}">Create</span>
                </a>
            </div>
        </div>
    </div>

    <div class="filter-section">
        <form class="row g-3">
                <div class="col-md-2">
                    <label class="form-label"><i class="fas fa-tags me-1"></i>[[#{filter.brand}]]</label>
                    <select name="brand" class="form-select">
                        <option value="" th:text="#{filter.all.brands}">T·∫•t c·∫£ th∆∞∆°ng hi·ªáu</option>
                        <option th:each="b : ${brands}" th:value="${b.slug}" th:text="${b.name}"
                                th:selected="${brand == b.slug}"></option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label"><i class="fas fa-list me-1"></i>[[#{filter.category}]]</label>
                    <select name="category" class="form-select">
                        <option value="" th:text="#{filter.all.categories}">T·∫•t c·∫£ danh m·ª•c</option>
                        <option th:each="c : ${categories}" th:value="${c.slug}" th:text="${c.name}"
                                th:selected="${category == c.slug}"></option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label"><i class="fas fa-dollar-sign me-1"></i>Gi√° t·ª´</label>
                    <input type="number" min="0" step="1000" class="form-control" name="minPrice" th:value="${minPrice}" placeholder="0">
                </div>
                <div class="col-md-2">
                    <label class="form-label"><i class="fas fa-dollar-sign me-1"></i>Gi√° ƒë·∫øn</label>
                    <input type="number" min="0" step="1000" class="form-control" name="maxPrice" th:value="${maxPrice}" placeholder="‚àû">
                </div>
                <div class="col-md-2">
                    <label class="form-label"><i class="fas fa-search me-1"></i>[[#{search.placeholder}]]</label>
                    <input class="form-control" name="q" th:value="${q}" th:placeholder="#{search.placeholder}">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-primary w-100" th:text="#{filter.button}">
                        <i class="fas fa-filter me-1"></i>Filter
                    </button>
                </div>
        </form>
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover bg-white shadow-sm">
            <thead>
            <tr>
                <th>
                    <a href="#" onclick="sortBy('id'); return false;" class="text-decoration-none">
                        <span th:text="#{product.id}">ID</span>
                        <i th:if="${sortBy == 'id'}" th:class="(${sortDir == 'asc'}) ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
                        <i th:unless="${sortBy == 'id'}" class="fas fa-sort text-muted"></i>
                    </a>
                </th>
                <th>
                    <a href="#" onclick="sortBy('title'); return false;" class="text-decoration-none">
                        <span th:text="#{product.title}">Title</span>
                        <i th:if="${sortBy == 'title'}" th:class="(${sortDir == 'asc'}) ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
                        <i th:unless="${sortBy == 'title'}" class="fas fa-sort text-muted"></i>
                    </a>
                </th>
                <th>
                    <a href="#" onclick="sortBy('price'); return false;" class="text-decoration-none">
                        <span th:text="#{product.price}">Price</span>
                        <i th:if="${sortBy == 'price'}" th:class="(${sortDir == 'asc'}) ? 'fas fa-sort-up' : 'fas fa-sort-down'"></i>
                        <i th:unless="${sortBy == 'price'}" class="fas fa-sort text-muted"></i>
                    </a>
                </th>
                <th th:text="#{product.condition}">Condition</th>
                <th th:text="#{product.brand}">Brand</th>
                <th th:text="#{product.category}">Category</th>
                <th th:text="#{product.seller}">Seller</th>
                <th th:text="#{verification.status}">Verification</th>
                <th th:text="#{product.actions}">Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="p : ${products}">
                <td th:text="${p.id}">1</td>
                <td>
                    <div class="d-flex align-items-center">
                        <!-- Hi·ªÉn th·ªã h√¨nh ·∫£nh s·∫£n ph·∫©m -->
                        <div class="me-3">
                            <img th:if="${p.imageUrl != null and p.imageUrl != ''}" 
                                 th:src="${p.imageUrl}" 
                                 alt="Product Image" 
                                 class="product-image">
                            <div th:unless="${p.imageUrl != null and p.imageUrl != ''}" 
                                 class="product-image bg-light d-flex align-items-center justify-content-center">
                                <i class="fas fa-image text-muted"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1 fw-semibold" th:text="${p.title}">Title</h6>
                            <div class="action-buttons">
                                <a class="btn-action btn-chat"
                                   th:attr="data-product-id=${p.id}, data-title=${p.title}"
                                   onclick="openChat(this)">
                                    <i class="fas fa-comments"></i><span th:text="#{chat.join}">Chat</span>
                                </a>
                                <!-- Buy button only for BUYER role -->
                                <a th:if="${p.active}" sec:authorize="hasRole('BUYER')"
                                   th:href="@{/orders/buy/{id}(id=${p.id})}" 
                                   class="btn-action btn-buy">
                                    <i class="fas fa-shopping-cart"></i><span th:text="#{product.buyNow}">Mua ngay</span>
                                </a>
                                <span th:unless="${p.active}" 
                                      class="badge bg-secondary" th:text="#{product.sold}">ƒê√£ b√°n</span>
                                <!-- Show login prompt for non-buyers -->
                                <small th:if="${p.active}" sec:authorize="!hasRole('BUYER')"
                                       class="text-muted" th:text="#{product.login.buyer.prompt}">ƒêƒÉng nh·∫≠p v·ªõi t√†i kho·∫£n BUYER ƒë·ªÉ mua</small>
                            </div>
                        </div>
                    </div>
                </td>
                <td>
                    <div th:if="${p.hasActivePromotion()}" class="price-display">
                        <div class="price-original" 
                             th:text="${#numbers.formatInteger(p.price,3,'POINT')} + ' ‚Ç´'">4,200,000 ‚Ç´</div>
                        <div class="price-current" 
                             th:text="${#numbers.formatInteger(p.discountedPrice,3,'POINT')} + ' ‚Ç´'">3,500,000 ‚Ç´</div>
                        <span class="price-sale-badge">Sale</span>
                    </div>
                    <div th:unless="${p.hasActivePromotion()}" class="price-display">
                        <div class="price-current" 
                             th:text="${#numbers.formatInteger(p.price,3,'POINT')} + ' ‚Ç´'">4,200,000 ‚Ç´</div>
                    </div>
                </td>
                <td th:text="#{'condition.' + ${p.conditionGrade}}">LIKE_NEW</td>
                <td th:text="${p.brand != null} ? ${p.brand.name} : '-'">Nike</td>
                <td th:text="${p.category != null} ? ${p.category.name} : '-'">Sneaker</td>
                <td th:text="${p.seller != null} ? ${p.seller.username} : '-'">Seller</td>
                <td>
                    <span class="badge bg-warning" th:text="#{product.pending}">Pending</span>
                </td>
                <td>
                    <div class="d-flex gap-1">
                        <!-- Ch·ªâ hi·ªÉn th·ªã n√∫t Edit/Delete cho admin ho·∫∑c seller s·ªü h·ªØu s·∫£n ph·∫©m -->
                        <a th:href="@{|/products/${p.id}/edit|}" class="btn btn-sm btn-primary"
                           th:text="#{btn.edit}"
                           sec:authorize="hasRole('ADMIN') or (hasRole('SELLER') and authentication.name == p.seller.username)">
                            <i class="fas fa-edit"></i>
                        </a>
                        <form th:action="@{|/products/${p.id}/delete|}" method="post" class="d-inline"
                              sec:authorize="hasRole('ADMIN') or (hasRole('SELLER') and authentication.name == p.seller.username)">
                            <button class="btn btn-sm btn-danger" 
                                    th:onclick="'return confirm(\'' + #{product.deleteConfirm} + '\')'">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

<!-- Chat modal -->
<div class="modal fade" id="chatModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="chatTitle" class="modal-title" th:text="#{product.chat}">Chat</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="chatBox" style="min-height:200px"></div>
            <div class="modal-footer">
                <input class="form-control" id="chatSender" th:placeholder="#{product.nickname}">
                <input class="form-control" id="chatInput" th:placeholder="#{product.message}">
                <button class="btn btn-primary" onclick="sendMsg()" th:text="#{product.send}">Send</button>
            </div>
        </div>
    </div>
</div>

<!-- Pagination -->
<div th:if="${totalPages > 1}" class="d-flex justify-content-between align-items-center mt-4">
    <div class="text-muted">
        Hi·ªÉn th·ªã <span th:text="${currentPage * pageSize + 1}">1</span> - 
        <span th:text="${(currentPage + 1) * pageSize > totalElements} ? ${totalElements} : ${(currentPage + 1) * pageSize}">10</span> 
        trong t·ªïng s·ªë <span th:text="${totalElements}">100</span> s·∫£n ph·∫©m
    </div>
    
    <nav>
        <ul class="pagination pagination-sm mb-0">
            <!-- Previous button -->
            <li class="page-item" th:classappend="${!hasPrevious} ? 'disabled'">
                <a class="page-link" href="#" onclick="goToPage(${currentPage - 1}); return false;">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
            
            <!-- Page numbers -->
            <li th:each="i : ${#numbers.sequence(0, totalPages - 1)}" 
                class="page-item" 
                th:classappend="${i == currentPage} ? 'active'">
                <a class="page-link" href="#" th:attr="onclick='goToPage(' + ${i} + '); return false;'" th:text="${i + 1}">1</a>
            </li>
            
            <!-- Next button -->
            <li class="page-item" th:classappend="${!hasNext} ? 'disabled'">
                <a class="page-link" href="#" onclick="goToPage(${currentPage + 1}); return false;">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        </ul>
    </nav>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    let stompClient = null, currentProductId = null;
    
    // Pagination function
    function goToPage(page) {
        const url = new URL(window.location);
        url.searchParams.set('page', page);
        window.location.href = url.toString();
    }
    
    // Sorting function
    function sortBy(sortBy) {
        const url = new URL(window.location);
        const currentSortBy = url.searchParams.get('sortBy') || 'id';
        const currentSortDir = url.searchParams.get('sortDir') || 'asc';
        
        if (currentSortBy === sortBy) {
            // Toggle direction
            url.searchParams.set('sortDir', currentSortDir === 'asc' ? 'desc' : 'asc');
        } else {
            // New column, default to asc
            url.searchParams.set('sortDir', 'asc');
        }
        
        url.searchParams.set('sortBy', sortBy);
        url.searchParams.set('page', '0'); // Reset to first page
        window.location.href = url.toString();
    }

    function connectWs(pid) {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, () => {
            stompClient.subscribe('/topic/chat.' + pid, (msg) => {
                const body = JSON.parse(msg.body);
                const box = document.getElementById('chatBox');
                const line = document.createElement('div');
                line.textContent = body.sender + ': ' + body.content;
                box.appendChild(line);
                box.scrollTop = box.scrollHeight;
            });
        });
    }

    function openChat(btn) {
        currentProductId = btn.getAttribute('data-product-id');
        document.getElementById('chatTitle').textContent = 'Chat - ' + btn.getAttribute('data-title');
        document.getElementById('chatBox').innerHTML = '';
        loadHistory(currentProductId);
        const modal = new bootstrap.Modal('#chatModal');
        modal.show();
        connectWs(currentProductId);
    }

    function loadHistory(pid) {
        fetch('/api/messages?productId=' + pid)
            .then(r => r.json())
            .then(msgs => {
                const box = document.getElementById('chatBox');
                msgs.forEach(msg => {
                    const line = document.createElement('div');
                    line.textContent = msg.senderName + ': ' + msg.content;
                    box.appendChild(line);
                });
                box.scrollTop = box.scrollHeight;
            });
    }

    function sendMsg() {
        const sender = document.getElementById('chatSender').value || 'guest';
        const content = document.getElementById('chatInput').value;
        if (!content) return;
        stompClient.send('/app/chat.send', {}, JSON.stringify({
            productId: currentProductId, 
            senderId: null, // Kh√¥ng c·∫ßn senderId
            sender: sender, 
            content: content
        }));
        document.getElementById('chatInput').value = '';
    }
</script>
</section>
</html>