<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(content=~{::section})}">
<section th:fragment="content">
    <div class="d-flex mb-3">
        <h3 class="me-auto" th:text="#{nav.products}">Products</h3>
        <a class="btn btn-success" th:href="@{/products/create}" th:text="#{btn.create}">Create</a>
    </div>

    <form class="row g-2 mb-3">
        <div class="col-auto">
            <select name="brand" class="form-select">
                <option value="">[[#{filter.brand}]]</option>
                <option th:each="b : ${brands}" th:value="${b.slug}" th:text="${b.name}"
                        th:selected="${brand == b.slug}"></option>
            </select>
        </div>
        <div class="col-auto">
            <select name="category" class="form-select">
                <option value="">[[#{filter.category}]]</option>
                <option th:each="c : ${categories}" th:value="${c.slug}" th:text="${c.name}"
                        th:selected="${category == c.slug}"></option>
            </select>
        </div>
        <div class="col-auto">
            <input class="form-control" name="q" th:value="${q}" th:placeholder="#{search.placeholder}">
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" th:text="#{filter.button}">Filter</button>
        </div>
    </form>

    <div class="table-responsive">
        <table class="table table-striped table-hover bg-white shadow-sm">
            <thead>
            <tr>
                <th th:text="#{product.id}">ID</th>
                <th th:text="#{product.title}">Title</th>
                <th th:text="#{product.price}">Price</th>
                <th th:text="#{product.condition}">Condition</th>
                <th th:text="#{product.brand}">Brand</th>
                <th th:text="#{product.category}">Category</th>
                <th th:text="#{product.seller}">Seller</th>
                <th th:text="#{verification.status}">Verification</th>
                <th th:text="#{product.actions}">Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="p : ${products}">
                <td th:text="${p.id}">1</td>
                <td>
                    <div class="d-flex align-items-center">
                        <!-- Hiển thị hình ảnh sản phẩm -->
                        <div class="me-3" style="width: 60px; height: 60px;">
                            <img th:if="${p.imageUrl != null and p.imageUrl != ''}" 
                                 th:src="${p.imageUrl}" 
                                 alt="Product Image" 
                                 class="img-thumbnail" 
                                 style="width: 100%; height: 100%; object-fit: cover;">
                            <div th:unless="${p.imageUrl != null and p.imageUrl != ''}" 
                                 class="bg-light d-flex align-items-center justify-content-center" 
                                 style="width: 100%; height: 100%; border: 1px solid #dee2e6;">
                                <i class="fas fa-image text-muted"></i>
                            </div>
                        </div>
                        <div>
                            <span th:text="${p.title}">Title</span>
                            <div class="mt-1">
                                <a class="btn btn-sm btn-outline-secondary me-1"
                                   th:attr="data-product-id=${p.id}, data-title=${p.title}"
                                   onclick="openChat(this)">[[#{chat.join}]]</a>
                                <a th:if="${p.active}" 
                                   th:href="@{/orders/buy/{id}(id=${p.id})}" 
                                   class="btn btn-sm btn-success" th:text="#{product.buyNow}">Buy Now</a>
                                <span th:unless="${p.active}" 
                                      class="badge bg-secondary" th:text="#{product.sold}">Sold</span>
                            </div>
                        </div>
                    </div>
                </td>
                <td>
                    <div th:if="${p.hasActivePromotion()}">
                        <div class="text-decoration-line-through text-muted small" 
                             th:text="${#numbers.formatInteger(p.price,3,'POINT')}">4,200,000</div>
                        <div class="text-danger fw-bold" 
                             th:text="${#numbers.formatInteger(p.discountedPrice,3,'POINT')}">3,500,000</div>
                        <span class="badge bg-danger" th:text="#{product.sale}">Sale</span>
                    </div>
                    <div th:unless="${p.hasActivePromotion()}" 
                         th:text="${#numbers.formatInteger(p.price,3,'POINT')}">4,200,000</div>
                </td>
                <td th:text="#{'condition.' + ${p.conditionGrade}}">LIKE_NEW</td>
                <td th:text="${p.brand != null ? p.brand.name : '-'}">Nike</td>
                <td th:text="${p.category != null ? p.category.name : '-'}">Sneaker</td>
                <td th:text="${p.seller != null ? p.seller.username : '-'}">Seller</td>
                <td>
                    <span class="badge bg-warning" th:text="#{product.pending}">Pending</span>
                </td>
                <td class="text-end">
                    <a th:href="@{|/products/${p.id}/edit|}" class="btn btn-sm btn-primary"
                       th:text="#{btn.edit}">Edit</a>
                    <form th:action="@{|/products/${p.id}/delete|}" method="post" class="d-inline">
                        <button class="btn btn-sm btn-danger" th:text="#{btn.delete}"
                                th:onclick="'return confirm(\'' + #{product.deleteConfirm} + '\')'">Delete
                        </button>
                    </form>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

<!-- Chat modal -->
<div class="modal fade" id="chatModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="chatTitle" class="modal-title" th:text="#{product.chat}">Chat</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="chatBox" style="min-height:200px"></div>
            <div class="modal-footer">
                <input class="form-control" id="chatSender" th:placeholder="#{product.nickname}">
                <input class="form-control" id="chatInput" th:placeholder="#{product.message}">
                <button class="btn btn-primary" onclick="sendMsg()" th:text="#{product.send}">Send</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script>
    let stompClient = null, currentProductId = null;

    function connectWs(pid) {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, () => {
            stompClient.subscribe('/topic/chat.' + pid, (msg) => {
                const body = JSON.parse(msg.body);
                const box = document.getElementById('chatBox');
                const line = document.createElement('div');
                line.textContent = body.sender + ': ' + body.content;
                box.appendChild(line);
                box.scrollTop = box.scrollHeight;
            });
        });
    }

    function openChat(btn) {
        currentProductId = btn.getAttribute('data-product-id');
        document.getElementById('chatTitle').textContent = 'Chat - ' + btn.getAttribute('data-title');
        document.getElementById('chatBox').innerHTML = '';
        loadHistory(currentProductId);
        const modal = new bootstrap.Modal('#chatModal');
        modal.show();
        connectWs(currentProductId);
    }

    function loadHistory(pid) {
        fetch('/api/messages?productId=' + pid)
            .then(r => r.json())
            .then(msgs => {
                const box = document.getElementById('chatBox');
                msgs.forEach(msg => {
                    const line = document.createElement('div');
                    line.textContent = msg.senderName + ': ' + msg.content;
                    box.appendChild(line);
                });
                box.scrollTop = box.scrollHeight;
            });
    }

    function sendMsg() {
        const sender = document.getElementById('chatSender').value || 'guest';
        const content = document.getElementById('chatInput').value;
        if (!content) return;
        stompClient.send('/app/chat.send', {}, JSON.stringify({
            productId: currentProductId, 
            senderId: null, // Không cần senderId
            sender: sender, 
            content: content
        }));
        document.getElementById('chatInput').value = '';
    }
</script>
</section>
</html>